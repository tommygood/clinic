<head>
    <title>
         看診明細
    </title>
    <script src = 'https://cdnjs.cloudflare.com/ajax/libs/axios/0.27.2/axios.min.js' ></script>
</head>
<style>
span {
}
</style>
<body>
    <h1>看診明細</h1>
    <div id = 'nId'></div>
    <form action = '/viewPa' method = 'post'>
        <input type = 'hidden' name = 'logout' value = '1'/>
        <input type = 'submit' value = '登出'/>
    </form>
    <a href = "/addPa">新增病人</a><br/>
    <a href = "/ckVac">疫苗紀錄</a><br/>
    <a href = "/ckMed">單筆藥品庫存紀錄</a><br/>
    <a href = "/allMed">藥品庫存紀錄</a><br/>
    <a href = "/addMed">新增藥品庫存</a><br/>
    <table id = 'tab' border = '2' align = center>
        <tr>
            <td><span id = "pat_name">姓名</span></td>
            <td><span id = 'time'>掛號時間</span></td><
            <td><span id = 'end_time'>完診時間</span></td><
            <td><span id = 'chart_num'>病歷號</span></td>
            <td><span id = 'id'>身份證號</span></td>
            <td><span id = 'sex'>性別</span></td>
            <td><span id = 'birth'>生日</span></td>
            <td><span id = 'tel1'>電話1</span></td>
            <td><span id = 'tel2'>電話2</span></td>
            <td><span id = 'mark'>註記</span></td>
            <td><span id = 'regist'>掛號費</span></td>
            <td><span id = 'part_self'>部份負擔</span></td>
            <td><span id = 'deposit'>押金</span></td>
            <td><span id = 'all_self'>自費</span></td>
            <td><span id = 'dId'>醫生代號</span><br/></td>
            <td><span id = 'dId'>是否在場</span><br/></td>
        </tr>
    </table>
    <div id = 'test'>123</div>
</body>
    <script>
        function jsonToString(json) {
            return Object.keys(json).map(function(key) {
                return encodeURIComponent(key) + '=' + encodeURIComponent(json[key]);
            }).join('&');
        }
        axios.get('/get', {
            params : {
                id : 5
            }
        })

        function getId(id) {
            return document.getElementById(id);
        }

        (async() => { // 查詢 nId
			const {data : user} = await axios.get('/viewPa/nId');
			getId('nId').innerHTML = "<b>" + user.nId + "</b> 號護士登入中";
        })();

        function alertLog(response) { // 登入
            for (let i = 0;i < response.data[response.data.length-1].length;i++) {
                if (response.data[response.data.length-1][i].status) 
                    return 1;
             }
            var name = prompt("請輸入您的帳號", ""); //將輸入的內容賦給變數 name ，
            var pass = prompt("請輸入您的密碼", ""); //將輸入的內容賦給變數 name ，
            var log_suc = 0;
            for (let i = 0;i < response.data[response.data.length-1].length;i++) {
                if (response.data[response.data.length-1][i].nId==name && response.data[response.data.length-1][i].pass==pass) {
                    //getId('nId').value = name;
                    alert('登入成功');
                    log_suc = 1;
                    return 1;
                }
            }
            if (log_suc == 0) {
                alert('登入失敗');
                location.reload();
            }
        }    

        axios.get('/records').then(function(response) {
            axios.get('/data').then(function(data) {
                axios.get('/no_records').then(function(no_rec) {
                    for (let i = 0;i < no_rec.data.length;i++) 
                        response.data.push(no_rec.data[i])
                    response.data.sort(function(a,b){
                        return a.r_num - b.r_num;
                    });
                    for (let j = 0;j < response.data.length;j++) { // 每一筆紀錄 
                        for (let i = 0;i < data.data.length;i++) { // left join 到 patients
                            if (response.data[j].pId == data.data[i].pId) { // 病人代號相同
                                var no_card = 0; // 是否未帶卡
                                tab.innerHTML += "<tr id = 'log_row" + j + "'/><td/>"+ data.data[i]["name"]  +  
                                "<td id = 'test1'>" + response.data[j].start + "</td>" +
                                "<td>" + response.data[j].end + "</td>" +
                                "<td>" + response.data[j].r_num + "</td>" +
                                "<td>" + data.data[i].id + "</td>" +
                                "<td>" + data.data[i].sex + "</td>" +
                                "<td>" + data.data[i].birth + "</td>" +
                                "<td>" + data.data[i].tel1 + "</td>" +
                                "<td>" + data.data[i].tel2 + "</td>" +
                                "<td>" + response.data[j].mark + "</td>" + 
                                "<td>" + response.data[j].regist + "</td>" +
                                "<td>" + response.data[j].self_part + "</td>" +
                                "<td>" + response.data[j].all_self + "</td>" +
                                "<td>" + response.data[j].deposit + "</td>" +
                                "<td>" + response.data[j].dId + "</td>" + 
                                "<td>" + response.data[j].in + "</td></tr>";
                                if (response.data[j].nrId != null) {
                                    try {
                                        var no_card_id = "log_row" + j;
                                        document.getElementById(no_card_id).style.backgroundColor = "red";
                                    }
                                    catch (e) {
                                        console.log(e);
                                    }
                                }
                                /*for (let k = 0;k < no_rec.data.length;k++) { //
                                    if (response.data[j].rId == no_rec.data[k].rId) {
                                        try {
                                            var no_card_id = "log_row" + j;
                                            document.getElementById(no_card_id).style.backgroundColor = "red";
                                        }
                                        catch (e) {
                                            console.log(e);
                                        }
                                    }
                                }*/
                            }
                        }
                    }
                })
            })
        })

    </script>
