<html>
    <head>
		<script src = "/socket.io/socket.io.js"></script>
		<script>
			var socket = io();
		</script>
        <title>
            醫生登錄頁面
        </title>
        <h1>
            醫生登錄頁面
        </h1>
    </head>
    <body id = 'body'>
		<div id = 'dId'></div>
        <form action = '/docMain' method = 'post'>
            <input type = 'hidden' name = 'logout' value = '1'/>
            <input type = 'submit' value = '登出'/>
        </form>
		<div id = 'doc_info'></div>
    <table id = 'tab' border = '2' align = center>
        <tr>
            <td><span id = 'num'>病歷號</span></td>
            <td><span id = 'time'>掛號時間</span></td><
            <td><span id = "pat_name">姓名</span></td>
            <td><span id = 'sex'>性別</span></td>
            <td><span id = 'birth'>生日</span></td>
            <td><span id = 'tel1'>電話1</span></td>
            <td><span id = 'tel2'>電話2</span></td>
            <td><span id = 'mark'>註記</span></td>
            <td><span id = 'regist'>掛號費</span></td>
            <td><span id = 'part_self'>部份負擔</span></td>
            <td><span id = 'all_self'>自費</span></td>
            <td><span id = 'deposit'>押金</span></td>
        </tr>
    </table>
		<input type = "input" id = 'msg'></div>
		<button id = "send_msg">send</button>
    </body>
    <script src = 'https://cdnjs.cloudflare.com/ajax/libs/axios/0.27.2/axios.min.js' ></script>
    <script>
		function getId(id) {
			return document.getElementById(id);
		}

		async function callPat(pa_num, rId) { // 按下看診
			const {data : insert_suc} = await axios.post('/docMain/patStart', {dId : getId('dId'), rId : rId});
			if (!insert_suc) {
				alert('更新開診時間失敗');
				return;
			}
			const {data : suc} = await axios.post('/docMain/getPa', {pa_num : pa_num}); // 檢查帳號的權限
			if (suc) {
				window.location.href = "/ckPatients";
			}
			else {
				alert('無此病患');
			}
		}

        (async() => {
			const {data : user} = await axios.get('/docMain/dId');
			const {data : rec} = await axios.get('/records');
			const {data : done} = await axios.get('/done_records');
			const {data : data} = await axios.get('/data');
			getId('dId').innerHTML = "<b>" + user.dId + "</b> 號醫生登入中";
			getId('doc_info').innerHTML = "<b>" + user.dId + "</b> 號醫生候診清單";
			/*var all_records = [];
			var done = false; // 是否已經完成
			for (let i = 0;i < no_rec.length;i++) // rec + no_rec
				rec.push(no_rec[i]);
			for (let i = 0;i < rec.length;i++) {// 加入所有紀錄(刪除完診的)
				done = false;
				for (let j = 0;j < done_records.length;j++) { // 已經完診的紀錄
					if (rec[i].r_num == done_records[j].r_num) { // 這筆紀錄已經完成
						done = true;
					}
				}
				if (!done) { // 還未完成的紀錄
					all_records.push(rec[i])
				}
			}
			let index = 0;
            all_records.sort(function(a,b){ // 時間排序
                return a.r_num - b.r_num;
            });
            for (let j = 0;j < all_records.length;j++) { // 每一筆紀錄 
            	for (let i = 0;i < data.length;i++) { // left join 到 patients
                    if (all_records[j].pId == data[i].pId && all_records[j].dId == user.dId) { // 病人代號 醫生代號相同 
						console.log(all_records[j]);
                        var no_card = 0; // 是否未帶卡
                	    tab.innerHTML += "<tr id = 'log_row" + j + "'/><td/>"+ data[i]["name"]  +  
                        "<td id = 'test1'>" + all_records[j].start + "</td>" +
                        "<td>" + all_records[j].num + "</td>" +
                        "<td>" + data[i].sex + "</td>" +
                        "<td>" + data[i].birth + "</td>" +
                        "<td>" + data[i].tel1 + "</td>" +
                        "<td>" + data[i].tel2 + "</td>" +
						"<td>" + all_records[j].mark + "</td>" +
						"<td><button id = '" + j + "' type = 'button' onclick = 'callPat(" + index + ")'(>看診</button></td></tr>"  
						index += 1;
                        if (all_records[j].nrId != null) { // no records
                        	try {
                            	var no_card_id = "log_row" + j;
                                document.getElementById(no_card_id).style.backgroundColor = "red";
                            }
                            catch (e) {
                                console.log(e);
                            }
                        }
                    }
                }
			}*/
			var in_patients;
			var index = 0;
			var in_done;
            for (let j = 0;j < rec.length;j++) { // 每一筆紀錄 
				in_patients = false; // 在病人的 table 裡
				in_done = false; // 還沒看過診
				for (let k = 0;k < done.length;k++) { // 是否已經看診過
					if (rec[j].no == done[k].rId) { // 看過了
						in_done = true;
						break;
					}
				}
				if (in_done) // 看過了
					continue; // 找下一個
                for (let i = 0;i < data.length;i++) { // left join 到 patients
                    if (rec[j].pId == data[i].pId && rec[j].dId == user.dId) { // 病人代號相同且醫生代號相同
						in_patients = true;
                        var no_card = 0; // 是否未帶卡
                        tab.innerHTML += 
						"<tr draggable='true' ondragstart='start()' " + " id = 'log_row" + j + "'/><td/>"+ rec[j].num  +  
                        "<td>" + rec[j].start + "</td>" +
                        "<td>" + data[i].name + "</td>" +
                        "<td>" + data[i].sex + "</td>" +
                        "<td>" + data[i].birth + "</td>" +
                        "<td>" + data[i].tel1 + "</td>" +
                        "<td>" + data[i].tel2 + "</td>" +
                        "<td>" + rec[j].mark + "</td>" + 
                        "<td>" + rec[j].regist + "</td>" +
                        "<td>" + rec[j].self_part + "</td>" +
                        "<td>" + rec[j].all_self + "</td>" +
						"<td>" + rec[j].deposit + "</td>" +
						"<td><button id = '" + j + "' type = 'button' onclick = 'callPat(" + index + "," + rec[j].no + ")'(>看診</button></td></tr>"  
						index += 1;
                    }
                }
				if (!in_patients && rec[j].dId == user.dId) { // 不在病患中，未帶卡或預約
                   	tab.innerHTML += 
					"<tr draggable='true' ondragstart='start()' " + " id = 'log_row" + j + "'/><td/>"+ rec[j].num  +  
                    "<td>" + rec[j].start + "</td>" +
                    "<td>" + null + "</td>" +
                    "<td>" + null + "</td>" +
                    "<td>" + null + "</td>" +
                    "<td>" + null + "</td>" +
                    "<td>" + null + "</td>" +
                    "<td>" + rec[j].mark + "</td>" + 
                    "<td>" + rec[j].regist + "</td>" +
                    "<td>" + rec[j].self_part + "</td>" +
                    "<td>" + rec[j].all_self + "</td>" +
					"<td>" + rec[j].deposit + "</td>" + 
					"<td><button id = '" + j + "' type = 'button' onclick = 'callPat(" + index + ")'(>看診</button></td></tr>"  
					index += 1;
                    var no_card_id = "log_row" + j;
                    document.getElementById(no_card_id).style.backgroundColor = "red";
				}
            }
        })();
        /*axios.get('/records').then(function(response) {
            axios.get('/data').then(function(data) {
					var in_patients;
                    for (let j = 0;j < response.data.length;j++) { // 每一筆紀錄 
						in_patients = false;
                        for (let i = 0;i < data.data.length;i++) { // left join 到 patients
                            if (response.data[j].pId == data.data[i].pId) { // 病人代號相同
								console.log(data.data[i]);
								in_patients = true;
                                var no_card = 0; // 是否未帶卡
                                tab.innerHTML += 
								"<tr draggable='true' ondragstart='start()' " + " id = 'log_row" + j + "'/><td/>"+ response.data[j].num  +  
                                "<td>" + response.data[j].start + "</td>" +
                                "<td>" + data.data[i].name + "</td>" +
                                "<td>" + data.data[i].sex + "</td>" +
                                "<td>" + data.data[i].birth + "</td>" +
                                "<td>" + data.data[i].tel1 + "</td>" +
                                "<td>" + data.data[i].tel2 + "</td>" +
                                "<td>" + response.data[j].mark + "</td>" + 
                                "<td>" + response.data[j].regist + "</td>" +
                                "<td>" + response.data[j].self_part + "</td>" +
                                "<td>" + response.data[j].all_self + "</td>" +
								"<td>" + response.data[j].deposit + "</td></tr>";
                            }
                        }
						if (!in_patients) { // 不在病患中，未帶卡或預約
                        	tab.innerHTML += 
								"<tr draggable='true' ondragstart='start()' " + " id = 'log_row" + j + "'/><td/>"+ response.data[j].num  +  
                                "<td>" + response.data[j].start + "</td>" +
                                "<td>" + null + "</td>" +
                                "<td>" + null + "</td>" +
                                "<td>" + null + "</td>" +
                                "<td>" + null + "</td>" +
                                "<td>" + null + "</td>" +
                                "<td>" + response.data[j].mark + "</td>" + 
                                "<td>" + response.data[j].regist + "</td>" +
                                "<td>" + response.data[j].self_part + "</td>" +
                                "<td>" + response.data[j].all_self + "</td>" +
								"<td>" + response.data[j].deposit + "</td></tr>";
                             var no_card_id = "log_row" + j;
                             document.getElementById(no_card_id).style.backgroundColor = "red";
						}
                    }
            })
        })*/

		getId("send_msg").addEventListener("click", sendMsg);

		function sendMsg() {
			var msg = getId("msg").value;
			socket.emit("docMsg", msg);
		}	

		socket.on("connect", function () {
			socket.emit("returnDocMsg");
		});

		socket.on("returnDocMsg", function (msg) {
			console.log(msg);
		});

	</script>
	<style>
		#doc_info {
			text-align : center;
			align : center;
		}
	</style>
</html>

