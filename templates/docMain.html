<html>
    <head>
        <title>
            醫生登錄頁面
        </title>
        <h1>
            醫生登錄頁面
        </h1>
    </head>
    <body>
		<div id = 'dId'></div>
        <form action = '/docMain' method = 'post'>
            <input type = 'hidden' name = 'logout' value = '1'/>
            <input type = 'submit' value = '登出'/>
        </form>
		<div id = 'doc_info'></div>
    <table id = 'tab' border = '2' align = center>
        <tr>
            <td><span id = "pat_name">姓名</span></td>
            <td><span id = 'time'>掛號時間</span></td><
            <td><span id = 'chart_num'>病歷號</span></td>
            <td><span id = 'sex'>性別</span></td>
            <td><span id = 'birth'>生日</span></td>
            <td><span id = 'tel1'>電話1</span></td>
            <td><span id = 'tel2'>電話2</span></td>
            <td><span id = 'mark'>註記</span></td>
        </tr>
    </table>
		
    </body>
    <script src = 'https://cdnjs.cloudflare.com/ajax/libs/axios/0.27.2/axios.min.js' ></script>
    <script>
		function getId(id) {
			return document.getElementById(id);
		}

		async function callPat(pa_num) {
			const {data : suc} = await axios.post('/docMain/getPa', {pa_num : pa_num});
			if (suc) {
				window.location.href = "/ckPatients";
			}
			else {
				alert('無此病患');
			}
		}

        (async() => {
			const {data : rec} = await axios.get('/records');
			const {data : no_rec} = await axios.get('/no_records');
			const {data : user} = await axios.get('/docMain/dId');
			const {data : done_records} = await axios.get('/done_records');
			const {data : data} = await axios.get('/data');
			//const all_rec = rec.concat(no_rec);
			getId('dId').innerHTML = "<b>" + user.dId + "</b> 號醫生登入中";
			getId('doc_info').innerHTML = "<b>" + user.dId + "</b> 號醫生候診清單";
			var all_records = [];
			var done = false; // 是否已經完成
			for (let i = 0;i < no_rec.length;i++)
				rec.push(no_rec[i]);
			for (let i = 0;i < rec.length;i++) {// 加入所有紀錄
				done = false;
				for (let j = 0;j < done_records.length;j++) { // 已經完診的紀錄
					if (rec[i].r_num == done_records[j].r_num) { // 這筆紀錄已經完成
						done = true;
					}
				}
				if (!done) { // 還未完成的紀錄
					all_records.push(rec[i])
				}
			}
			let index = 0;
            all_records.sort(function(a,b){
                return a.r_num - b.r_num;
            });
            for (let j = 0;j < all_records.length;j++) { // 每一筆紀錄 
            	for (let i = 0;i < data.length;i++) { // left join 到 patients
                    if (all_records[j].pId == data[i].pId && all_records[j].dId == user.dId) { // 病人代號 醫生代號相同 
						console.log(all_records[j]);
                        var no_card = 0; // 是否未帶卡
                	    tab.innerHTML += "<tr id = 'log_row" + j + "'/><td/>"+ data[i]["name"]  +  
                        "<td id = 'test1'>" + all_records[j].start + "</td>" +
                        "<td>" + all_records[j].num + "</td>" +
                        "<td>" + data[i].sex + "</td>" +
                        "<td>" + data[i].birth + "</td>" +
                        "<td>" + data[i].tel1 + "</td>" +
                        "<td>" + data[i].tel2 + "</td>" +
						"<td>" + all_records[j].mark + "</td>" +
						"<td><button id = '" + j + "' type = 'button' onclick = 'callPat(" + index + ")'(>看診</button></td></tr>"  
						index += 1;
                        if (all_records[j].nrId != null) {
                        	try {
                            	var no_card_id = "log_row" + j;
                                document.getElementById(no_card_id).style.backgroundColor = "red";
                            }
                            catch (e) {
                                console.log(e);
                            }
                        }
                    }
                }
			}
        /*axios.get('/records').then(function(response) {
            axios.get('/data').then(function(data) {
                axios.get('/no_records').then(function(no_rec) {
						
                    for (let i = 0;i < no_rec.data.length;i++) // 加入所有紀錄
                        response.data.push(no_rec.data[i])
                    response.data.sort(function(a,b){
                        return a.r_num - b.r_num;
                    });
					let index = 0;
                    for (let j = 0;j < response.data.length;j++) { // 每一筆紀錄 
                        for (let i = 0;i < data.data.length;i++) { // left join 到 patients
                            if (response.data[j].pId == data.data[i].pId && response.data[j].dId == user.dId) { // 病人代號 醫生代號相同 
                                var no_card = 0; // 是否未帶卡
                                tab.innerHTML += "<tr id = 'log_row" + j + "'/><td/>"+ data.data[i]["name"]  +  
                                "<td id = 'test1'>" + response.data[j].start + "</td>" +
                                "<td>" + response.data[j].num + "</td>" +
                                "<td>" + data.data[i].sex + "</td>" +
                                "<td>" + data.data[i].birth + "</td>" +
                                "<td>" + data.data[i].tel1 + "</td>" +
                                "<td>" + data.data[i].tel2 + "</td>" +
								"<td>" + response.data[j].mark + "</td>" +
								"<td><button id = '" + j + "' type = 'button' onclick = 'callPat(" + index + ")'(>看診</button></td></tr>"  
								index += 1;
                                if (response.data[j].nrId != null) {
                                    try {
                                        var no_card_id = "log_row" + j;
                                        document.getElementById(no_card_id).style.backgroundColor = "red";
                                    }
                                    catch (e) {
                                        console.log(e);
                                    }
                                }
                            }
                        }
					}
				})
			})
		})*/
        })();
		
        /*axios.get('/records').then(function(response) {
            axios.get('/data').then(function(data) {
                axios.get('/no_records').then(function(no_rec) {
                    for (let i = 0;i < no_rec.data.length;i++) 
                        response.data.push(no_rec.data[i])
                    response.data.sort(function(a,b){
                        return a.r_num - b.r_num;
                    });
                    for (let j = 0;j < response.data.length;j++) { // 每一筆紀錄 
                        for (let i = 0;i < data.data.length;i++) { // left join 到 patients
                            if (response.data[j].pId == data.data[i].pId) { // 病人代號相同
                                var no_card = 0; // 是否未帶卡
                                tab.innerHTML += "<tr id = 'log_row" + j + "'/><td/>"+ data.data[i]["name"]  +  
                                "<td id = 'test1'>" + response.data[j].start + "</td>" +
                                "<td>" + response.data[j].num + "</td>" +
                                "<td>" + data.data[i].sex + "</td>" +
                                "<td>" + data.data[i].birth + "</td>" +
                                "<td>" + data.data[i].tel1 + "</td>" +
                                "<td>" + data.data[i].tel2 + "</td>" +
								"<td>" + response.data[j].mark + "</td></tr>"  
                                if (response.data[j].nrId != null) {
                                    try {
                                        var no_card_id = "log_row" + j;
                                        document.getElementById(no_card_id).style.backgroundColor = "red";
                                    }
                                    catch (e) {
                                        console.log(e);
                                    }
                                }
                            }
                        }
					}
				})
			})
		})*/
	</script>
	<style>
		#doc_info {
			text-align : center;
			align : center;
		}
	</style>
</html>

