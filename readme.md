# 診所系統(包含掛號 藥品管理 帳務...)

## 詳細資訊
- https://hackmd.io/@tommygood/clinic

## 主要功能
- 聊天室
    - 說明 : 即時溝通，會顯示職位，並用框框匡選每一次的訊息
    - 功能 : 
        - **普通訊息** : 會及時更新到每一個聊天室，但重新載入會洗掉。
        - **重要訊息** : 
        訊息前後加上 **，ex. `**hello**`。變成重要訊息，會新增一筆重要訊息到 keep_messages，此留言每次重新載入 **不會** 被洗掉。
        有提供叉叉(刪除)此則重要訊息的功能，會再新增一筆刪除重要訊息的紀錄到 deleted_keep_messages，此使用者就不會再顯示這筆訊息。
    - 醫生聊天室 : 看完診後會自動新增一筆紀錄(包含醫生代號、看診號)至聊天室
    - ![image](https://github.com/tommygood/clinic/assets/96759292/796e5679-435b-46b2-9359-948503e81d5c)

- 掛號(新增病人)
    - 說明 : 若是第一次看診, 會把患者資料放進資料庫, 之後就不會再放。若是沒帶卡，會先不填該病患的資料，等到下一次還卡的時候再輸入。
    - 功能 : 
        - 搜尋 : 可以用 生日, 姓名, 電話1, 電話2, 身分證 搜尋病人, 依照編號按下放入就可以自動填入
        - 是否付款 : updateIn(), 掛號時可以選擇是否已經付款, 候診病人清單時也可以更改(要按保存更改)
        - 未帶健保卡 : 先不輸入病人資料, 若病人來還卡, 可以到候診病人清單或欠卡紀錄歸還
        - 打疫苗 : 勾選打疫苗後, 會多出一個可以選擇疫苗型號的欄位
            - 新版 : 按下打疫苗，會有一張所有疫苗的選單可以勾選。
            - 可以同筆紀錄施打多筆疫苗
        - 不在場 : 可勾選病患是否在場
        - 付費預設值 : 掛號費 : 150, 自費 : 0, 部分負擔 : 0, 押金 : 若勾選沒帶健保卡是 600, 有帶是 0
            - 新版 : 會根據身分不同去判別，目前身分有健保，勞保，親友，員工。
        - 編輯病患資料 : 先找出病患後，可以編輯病患資料，不過要先輸入該帳號密碼。
            - 備份 : 每次編輯更新資料之前，都會紀錄一筆原本的資料進 backup_patients。
        - 新增病患資料 : 可以直接按新增病人就可以新增病患資料。
        - 地址索引功能 : 已經可以搜尋到路名。
    - 新版說明 : 改成找到病患後，可以直接點選要進行 看診、押單、疫苗、自費四種功能。
        - 新增病人 : 會檢查身分證字號是否有重複。
        - 編輯病人 : 身分證字號欄位會變得不能修改(前端防呆)，後端也還會再檢查一次，有相同身分證字號才能修改。
        - 還單
            - 某個病人來還單，會把最早的一筆欠單紀錄還清
            - 還單一次只能還一筆(一天只能還一次)，所以會檢查當天是否有掛過號、還過卡
        - 尋找家屬 : 按下尋親，就會用 母身分證、電話1、電話2、地址 去尋找以上有相同的病患
        - 掛號會在前端檢查收費欄位有沒有非數字型態以外的字元
        - 掛號會在前端檢查收費欄位有沒有非數字型態以外的字元
            - checkChargeType()
        - 掛號輸入醫生代碼會檢查是否有此醫生
            - checkDoc()
        - 加藥：記錄欠卡紀錄，不收押金，只收部分負擔和自費。
    - ![image](https://github.com/tommygood/clinic/assets/96759292/3900050c-1501-4ddd-ba4e-f9c77874ed30)
    - ![image](https://github.com/tommygood/clinic/assets/96759292/90038278-4296-4b64-bca4-c81eab5ae282)



- 候診病人清單
    - 說明 : 顯示所有醫生的候診清單、是否付款(不能更改)、是否在場(可以更改)。可以更換病患順序，刪除紀錄，還卡，更新病患是否在場。 
    - 功能 : 
        - 刪除 : 把一筆還沒看診過的 record 刪除，會把這筆 rId 新增到 done_records 和 deleted_records。
        - 更換病患順序 : 可以用拖曳的方式更換順序，每次拖曳完後會重新排序，拖曳後須按保存更改才會更新。會記錄一筆 log 到資料庫，記錄是誰、哪一筆資料、從起點移到終點的資訊。
        - 還卡 : 若病患來還卡，或者是輸錯病患資料，可以從這裡更改病患資料。
        - 在場 : 可以勾選是否在場，勾選完後，需按保存更改。
        - 顯示所有 title 為醫生的帳號
    - ![image](https://github.com/tommygood/clinic/assets/96759292/732d0c1e-4f8f-4231-86ee-6e86b8896d92)


- 診所首頁
    - 說明 : 不需要憑證，病患可以查看每一位醫生的候診清單，只會顯示順序、是否在場、名字(不是全部 ex. 王O權)。
    - ![image](https://github.com/tommygood/clinic/assets/96759292/2ab23d11-1b30-4c84-8406-1e52063f6dcc)

    
- 歷史看診紀錄
    - 說明 : 會把所有的紀錄(除了已刪除紀錄)放進去，包含已完診、未完診，醫生可以查看每一位完診病患的病單，也可以複製該病單。
    - 功能 : 
        - 複製歷史病單紀錄
        - 分頁功能 : 
            - 固定一行頁數(目前設定10頁，若總頁數 < 10，會變為總頁數)
            - 首頁、尾頁、上頁、下頁
            - 標示當前頁數
            - 固定頁標位置
            - 預設一開始先載入第一位醫生的第一頁
            - 切換不同醫生，頁數會回到第一頁
        - 顯示所有 title 為醫生的帳號
      - ![image](https://github.com/tommygood/clinic/assets/96759292/34462bc0-15e8-48e4-8db1-f6f73a42fbaa)

- 今日看診紀錄
    - 說明 : 今日看診紀錄。功能和歷史一樣，差在只有今日的紀錄。

- 疫苗紀錄
    - 說明 : 分成 歷史、今日疫苗紀錄，若單次打多筆疫苗會以多筆紀錄顯示。
        - 功能 : 
             - 分頁功能 : 一頁 14 列，最多一次顯示 10 頁
    - ![image](https://github.com/tommygood/clinic/assets/96759292/a24a4599-a4cf-4f44-89d6-b1c935c3f611)


- 藥品庫存紀錄
    - ![](https://i.imgur.com/u8mTOmI.jpg)

    - 說明 : 顯示該名帳號負責的藥品，以分頁方式顯示。
    - ![image](https://github.com/tommygood/clinic/assets/96759292/7ba2933d-07db-4ef1-b00b-4b0834c7d482)

- 單筆藥品庫存紀錄
    - 說明 : 顯示每一筆藥品增減紀錄，包括買賣藥(med_inventory_each)、開藥紀錄(each_use_medicines)。
    - 功能 : 
        - 可以選擇當月、當週、當日的紀錄。
        - sort time : 因為一筆紀錄開始的時間有可能是 purchase_date 或 times，所以要去排序加總後的這兩個。
        - 分頁功能。
        - 依照進貨日期由近而遠排序。
    - ![image](https://github.com/tommygood/clinic/assets/96759292/417d71c1-b931-42a9-adc3-a6d8c0252157)

- 新增藥品
    - 說明 : 提供各種新增或減少藥品的方式以及其對應的欄位。
    - 欄位 : 通用欄位 - 藥碼、數量、註記。
        - 購入 : 使用期限、價錢。
        - 賣出 : 價錢。
        - 借出 : 
        - 借入 : 使用期限。
        - 被還 : 使用期限。
        - 還出 : 
        - 遺失 : 
        - 找回 : 使用期限。
    - ![image](https://github.com/tommygood/clinic/assets/96759292/2ca59ce0-418b-4b15-b02b-23ef023c0fbe)

- 主責帳號 : 
    - 說明 : 可以記錄在哪段時間是誰上班，並藉由記錄主責帳號是誰，來判斷當下時段發生的事情該由誰負責(ex. 錢清點不對)。
    - 功能 : 記錄哪一個帳號的開始工作及結束時間，且可勾選是否為主責。
    - ![image](https://github.com/tommygood/clinic/assets/96759292/b2dde6a2-475b-4f4b-8fc7-333e014b472f)


- 總帳務表 : 
    - 說明 : 全部的帳務記錄(包括掛號相關費用、藥品費用)。
    - 功能 : 會在理由欄位說明哪一筆編號及理由。
        - 理由對應編號的細項 :
            - 病單號 : 找出該掛號紀錄(record)，再找出該病人的資訊
            - 藥物減少 : 找出藥物使用紀錄(each_use_medicine)，顯示使用量
            - 藥物增加 : 找出藥物進貨紀錄(med_inventory_each)，顯示原始數量
            - 其他的就顯示無
    - ![image](https://github.com/tommygood/clinic/assets/96759292/a727a3f8-af62-475a-a153-5478c129858e)
    - ![image](https://github.com/tommygood/clinic/assets/96759292/3c0f6ff0-72a5-4a0d-a8ed-5ab828213374)



- 當班帳務 : 
    - 說明 : 記錄這個班的帳務，每次下班前須去結算這個班的總金額，會記錄此班的結算金額及負責人員。
    - 功能 : 
        - 結算時可以備註有甚麼問題。
        - 若記錯了，可以更改該筆的金額，且須填更改理由(必填)，再按下保存更改即可。
        - 在今日帳務頁面多一個 table 可以輸入非固定理由的帳務
            - 送出前會檢查理由欄位是否為空和金額欄位是否為數字，若都成功就會新增
            - 可以更改 total_row 來增減 table 的 row 行數
        - 在結算款項時可以輸入要留給下一個班的金額
            - 會在這一班新增一筆給下一班的費用(負的)，再去下一班新增一筆上一班給的費用(正的)，這樣收支就會是一樣的
        - 理由對應編號的細項 :
            - 病單號 : 找出該掛號紀錄(record)，再找出該病人的資訊
            - 藥物減少 : 找出藥物使用紀錄(each_use_medicine)，顯示使用量
            - 藥物增加 : 找出藥物進貨紀錄(med_inventory_each)，顯示原始數量
            - 其他的就顯示無
    - ![image](https://github.com/tommygood/clinic/assets/96759292/f87b51f8-c621-46f1-ac35-915aceb79670)

- 欠卡記錄 : 
    - 說明 : 顯示所有欠卡記錄(包括已歸還、未歸還。)。
    - 功能 : 
        - 可以歸還卡片。
    - ![image](https://github.com/tommygood/clinic/assets/96759292/b5fe92d4-ff69-4e1e-a891-c0298bccc4ae)

- 債務紀錄
    - 說明 : 
        - 會顯示欠債中的款項。
        - 當掛號時勾選未付款, 就不會新增到帳務紀錄(financial record), 而是新增到欠債紀錄(debt)。
        - 要歸還款項要去債務紀錄按歸還。
    - ![image](https://github.com/tommygood/clinic/assets/96759292/dadce180-f6aa-40c1-833c-dba051ab9995)

- 登入 : 
    - 說明 : 會依照登入帳號去設 cookie，{title : 職位, aId : 帳號代號}

- 登出 : 
    - 說明 : 
        - 清除 cookie。
        - 如果是護士，會先檢查當班帳務是否結算完畢，若沒有會跳警告。

- 已結算記錄 : 
    - 說明 : 顯示所有已結算記錄(可以選擇是否要顯示已核對記錄)，以及其細項，並可以核對已結算記錄。
    - 功能 : 
        - 核對。
        - 顯示已核對記錄，再按一下不顯示。
        - 顯示細項。
        - 排版 : 3 個 table 都用 scroll，不重疊。
    - ![image](https://github.com/tommygood/clinic/assets/96759292/06b2ff2c-e605-4630-a11a-4fb1f8a16dd1)

- 歸還記錄 : 
    - 說明 : 顯示所有未歸還債務(病人掛號時還未付款，可能是掛號的)，可以歸還債務。
    - 功能 : 
        - 歸還，會記錄負責歸還的人，且會把此筆記錄記回總帳務記錄、當班帳務記錄。

- 醫生登入頁面 : 
    - 說明 : 列出當前醫生的看診清單，選擇病患進行看診。
    - 功能 : 按下該病患的看診後，會記錄一筆開始看診的時間到 record。
    - ![image](https://github.com/tommygood/clinic/assets/96759292/da2f6ec5-10b6-474e-bffd-b73d0abae6e6)

- 醫生看診頁面 : 
    - 說明 : 顯示該病患的部分資料，其中費用醫生可以調整。可查看該病患的上、下次病單，或貼上從別的病單複製過來的資料。
    - 功能 : 
        - 藥品欄格式 : 
            - 註記只要2個字元、用法4個、天數2、數量4(整數)+1(小數點)、藥品名稱(10~20)
        - 上、下次病歷 : 最上次的病歷後再按會顯示沒有更之前的，最下次會清空。
        - 快捷鍵 : 
            - 說明 : 會依照資料庫的設定對應快捷。
            - 使用方式 : 在 / 後輸入對應的，再按下 enter。`ex. /ts3`，enter。 
            - 可以使用的位置 : 主訴、理學、藥品名稱。
        - 費用調整 : 改完後，看診完成後就會更改費用。
        - 看診暫存 : 
            - 如果醫生不是因看診完畢離開頁面，此 record 就會新增一筆暫存檔案進 backup_diagnose_records、backup_medicines_records。
            - 同一個 rId 只會有一筆暫存檔，如果之前已經有暫存過一筆資料，就會直接覆蓋。
            - 可以暫存處方簽。
        - 處方籤 : 醫生可以在藥品名稱的欄位打處方籤。
            - 判別方式 : 如果沒有在資料庫找到相同的藥品名稱，就會判定這是處方籤，一樣和一般的藥品都會到 medicines_records，但是會新增到subscript 欄位，其他的欄位就空著。 
        - 列印 : 醫生看完診後可以選擇是否要列印。若要，會匯出 pdf 檔。
        - 看診用藥 : 會優先用有效期限快到的藥，會記錄一筆使用了多少的藥到 each_use_medicines，再更新原本 med_inventory_each 的 now_quantity。
            - 多個批次 : 若同一次開藥用到多個批次的藥，會先從有效期校快到的開始用，再慢慢往下找。
            - 沒有庫存 : 若庫存量 < 需求量，就不能看診。會顯示哪一筆藥品名稱、藥碼、需求、庫存。
        - 檢查每日量的小數點後是否 > 兩個數字
        - 看診頁面新增一個 新增欄位 的按鈕，每按一下就會兩列都會各新增一組藥物輸入欄位
        - 檢查醫生看診如果用到沒有存在過的藥，且會跳警告
        - 新增家人關係圖
            - 包含姓名、關係、年紀、病史。
        - 更新上下病歷到最後一個，會直接清空的問題
            - 當按上下病歷的按鈕且目前的藥單是該次看診的，會先暫存紀錄到變數。當下個病歷到最後一個會把暫存的資料叫出來。
        - 更新藥物超過預設限制會有的貼上、暫存、上下個病歷的顯示問題。
            - 更新從歷史看診明細複製過來也會有的這個問題。
                - 藥物紀錄 medicines_records，新增 put_index，記錄網頁顯示的位置(id)。
        - 推薦主訴
             - 會依據變更不同診斷推薦主訴，只須點一下，內容就會新增到主訴。
        - loading 畫面
            - 醫生看診在送出看診後到後端跑完為止，會顯示 loading 畫面，直到後端跑完回傳，就會隱藏。
        - 新增藥品資訊欄位
            - 藥品欄位的輸入框有 input、click 兩種 event，還有觸發 hot_key，共三種情況。
            - 觸發其中一行的其中一個(藥品名稱、每日量、用法、註)個都會去找該行的藥品名稱，再去用藥品名稱查對應的藥品資訊。
        ![](https://i.imgur.com/2ne0feL.png)
        - 新增該次病歷屬於哪個病單號和完診時間，會依上下次病歷而不同。
        - 新增常用藥品的 datalist，可以點選各個藥品
        - 新增依據診斷推薦藥品，並計算藥品量，目前先依身高、體重隨便算
        - ![image](https://github.com/tommygood/clinic/assets/96759292/b4dccb92-a15d-4091-9219-e37c04fb2dad)
        - ![image](https://github.com/tommygood/clinic/assets/96759292/c319c8db-1842-4481-9277-9515628498e6)


- 病單查詢頁面 : 醫生可以藉由用歷史看診紀錄點選已經完診的病人的病單查看病單，若還沒完診會跳警告。
    - 功能 : 
        - 只能查看病患的病單紀錄，不能修改。
        - `會檢查該病單的藥數量是否有超過原本預設(10*2)，如果超過，就會跟進，比如說原病單的總藥數量是 22 筆，就會把格子加到 22 格(11*2)，才能顯示所有藥。`
    - 隱憂 : 
        - 醫生的開藥排序若不是從第一直行再到第二直行，呈現的閱讀藥單方式會有錯
    - ![image](https://github.com/tommygood/clinic/assets/96759292/52618994-a69a-4a85-87e9-5912586686fc)
    
- 快捷鍵對應表
    - 位置 : /hot_key/relation
    - 功能 : 
        - 新增快捷 : 可以輸入真實名稱和對應快捷來新增。
        - 目前快捷的 table 有拉霸
        - 搜尋 : 可以用真實名稱或對應名稱找。輸入空白後會回去全部的快捷。
        - 顯示打疫苗 : 會顯示該病患施打哪幾種疫苗在主訴理學。
    - ![image](https://github.com/tommygood/clinic/assets/96759292/41f893be-09d9-438f-99dd-bd79f5edf168)
        
- 註冊帳號 : 
    - 位置 : /regist
    - 說明 : 需登入權限 = super 的帳號才能使用
    - 功能 :
        - 可以看到目前所有帳號的資訊。
        - 新增各種權限之帳號，帳號是預設就會給(不能更改)，從 1 開始。
            - 新增會檢查帳號是否有重複。
            - 新增會檢查帳號權限是否有在全部種類的帳號權限(super - 管理員, doc - 醫生, nur - 護士, medi - 藥師, others - 其他員工)之中。
    - ![image](https://github.com/tommygood/clinic/assets/96759292/40ef8462-41d0-4eaa-a887-ea5fa54562a9)

## 其他功能
- 分頁(可以限制一頁欄位數)
先去抓總紀錄數，最後依照 總紀錄數/一頁欄位數 去排

- 複製病歷和貼上
複製每一個 class = 'copy' 的欄位，並每一個元素複製完後會用 <new_element> 隔開，再
把最後加完的字串 split 開來，貼上對應的欄位。

- 病人藥單的藥品 element 自動化
只要改 medicine_input_num，就可以自動新增藥品欄位，不過要注意對應的功能是否正常。

- 下一個班的人要能夠核對上一個班的結算金額正確
新增 已結算紀錄(done_financial) 頁面, 裡面有尚未核對的已結算紀錄, 下一個班有查看細項和核對金額無誤的功能
